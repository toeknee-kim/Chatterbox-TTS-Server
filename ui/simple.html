<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatterbox TTS</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 700px;
            margin: 0 auto;
            padding: 40px 20px;
            background: #0f0f0f;
            color: #e0e0e0;
            min-height: 100vh;
        }
        h1 {
            text-align: center;
            margin-bottom: 10px;
            font-weight: 600;
            color: #fff;
        }
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }
        .tab {
            flex: 1;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #888;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }
        .tab:hover { background: #252525; color: #aaa; }
        .tab.active { background: #5c6bc0; border-color: #5c6bc0; color: #fff; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: flex; gap: 15px; }
        .form-row .form-group { flex: 1; }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #b0b0b0;
            font-size: 14px;
        }
        input[type="text"], textarea {
            width: 100%;
            padding: 14px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 15px;
            background: #1a1a1a;
            color: #e0e0e0;
            transition: border-color 0.2s;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #5c6bc0;
        }
        select {
            width: 100%;
            padding: 14px;
            border: 1px solid #333;
            border-radius: 8px;
            font-size: 15px;
            background: #1a1a1a;
            color: #e0e0e0;
            cursor: pointer;
        }
        select:focus { outline: none; border-color: #5c6bc0; }
        button {
            width: 100%;
            padding: 16px;
            background: #5c6bc0;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }
        button:hover:not(:disabled) { background: #7986cb; }
        button:disabled { background: #333; color: #666; cursor: not-allowed; }
        .btn-secondary { background: #333; color: #e0e0e0; }
        .btn-secondary:hover:not(:disabled) { background: #444; }
        .audio-container {
            margin-top: 25px;
            padding: 20px;
            background: #1a1a1a;
            border-radius: 8px;
            display: none;
        }
        .audio-container.visible { display: block; }
        audio { width: 100%; margin-top: 10px; }
        .status {
            text-align: center;
            margin-top: 20px;
            color: #888;
            min-height: 24px;
            font-size: 14px;
        }
        .status.error { color: #ef5350; }
        .status.generating { color: #5c6bc0; }
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 10px;
        }
        .tag {
            padding: 6px 12px;
            background: #252525;
            border: 1px solid #333;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
            color: #b0b0b0;
        }
        .tag:hover { background: #333; border-color: #5c6bc0; color: #fff; }
        .timer { font-size: 14px; color: #666; }
        .response-output {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
            display: none;
        }
        .response-output.visible { display: block; }
        .response-output .response-label {
            color: #5c6bc0;
            font-weight: 600;
            margin-bottom: 10px;
            display: block;
        }
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .checkbox-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        .checkbox-group label { margin: 0; cursor: pointer; }
        .model-status {
            text-align: center;
            padding: 8px;
            background: #1a1a1a;
            border-radius: 6px;
            font-size: 12px;
            margin-bottom: 20px;
        }
        .model-status.loaded { color: #66bb6a; }
        .model-status.not-loaded { color: #ffa726; }
        .chat-container {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .message-input-row {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }
        .message-input-row .form-group:first-child {
            flex: 0 0 150px;
        }
        .message-input-row .form-group:last-child {
            flex: 1;
        }
    </style>
</head>
<body>
    <h1>Chatterbox TTS</h1>
    <p class="subtitle">AI Voice Chat & Text-to-Speech</p>

    <div class="tabs">
        <div class="tab active" onclick="switchTab('chat')">AI Chat</div>
        <div class="tab" onclick="switchTab('manual')">Manual TTS</div>
    </div>

    <!-- AI Chat Tab -->
    <div id="chat-tab" class="tab-content active">
        <div id="model-status" class="model-status not-loaded">SmolLM3: Checking...</div>

        <div class="chat-container">
            <div class="message-input-row">
                <div class="form-group">
                    <label for="username">Your Name</label>
                    <input type="text" id="username" value="User" placeholder="Your name">
                </div>
                <div class="form-group">
                    <label for="message">Your Message</label>
                    <input type="text" id="message" placeholder="Say something..." value="Hey, what's up?">
                </div>
            </div>
        </div>

        <div class="form-row">
            <div class="form-group">
                <label for="chat-voice">AI Voice</label>
                <select id="chat-voice">
                    <option value="MickeyMouse.mp3">Mickey Mouse</option>
                    <option value="Emily.wav">Emily</option>
                    <option value="Olivia.wav">Olivia</option>
                    <option value="Michael.wav">Michael</option>
                    <option value="Alexander.wav">Alexander</option>
                    <option value="Alice.wav">Alice</option>
                    <option value="Adrian.wav">Adrian</option>
                    <option value="Connor.wav">Connor</option>
                    <option value="Cora.wav">Cora</option>
                    <option value="Elena.wav">Elena</option>
                    <option value="Gabriel.wav">Gabriel</option>
                    <option value="Henry.wav">Henry</option>
                    <option value="Jade.wav">Jade</option>
                    <option value="Jordan.wav">Jordan</option>
                    <option value="Layla.wav">Layla</option>
                    <option value="Ryan.wav">Ryan</option>
                    <option value="Taylor.wav">Taylor</option>
                </select>
            </div>
            <div class="form-group">
                <label for="chat-style">Response Style</label>
                <select id="chat-style">
                    <option value="friendly">Friendly</option>
                    <option value="excited">Excited</option>
                    <option value="calm">Calm</option>
                    <option value="sarcastic">Sarcastic</option>
                    <option value="professional">Professional</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="chat-include-tags" checked>
                <label for="chat-include-tags">Include expressions ([laugh], [sigh], etc.)</label>
            </div>
        </div>

        <div style="display: flex; gap: 10px;">
            <button id="text-only-btn" class="btn-secondary" onclick="generateTextOnly()" style="flex: 1;">Text Only</button>
            <button id="chat-speak-btn" onclick="chatAndSpeak()" style="flex: 2;">Send & Speak</button>
        </div>

        <div id="response-output" class="response-output">
            <span class="response-label">AI Response:</span>
            <span id="response-text"></span>
        </div>
    </div>

    <!-- Manual TTS Tab -->
    <div id="manual-tab" class="tab-content">
        <div class="form-group">
            <label for="voice">Voice</label>
            <select id="voice">
                <option value="Emily.wav">Emily</option>
                <option value="Olivia.wav">Olivia</option>
                <option value="Michael.wav">Michael</option>
                <option value="Alexander.wav">Alexander</option>
                <option value="Alice.wav">Alice</option>
                <option value="Adrian.wav">Adrian</option>
                <option value="Abigail.wav">Abigail</option>
                <option value="Austin.wav">Austin</option>
                <option value="Axel.wav">Axel</option>
                <option value="Connor.wav">Connor</option>
                <option value="Cora.wav">Cora</option>
                <option value="Elena.wav">Elena</option>
                <option value="Eli.wav">Eli</option>
                <option value="Everett.wav">Everett</option>
                <option value="Gabriel.wav">Gabriel</option>
                <option value="Gianna.wav">Gianna</option>
                <option value="Henry.wav">Henry</option>
                <option value="Ian.wav">Ian</option>
                <option value="Jade.wav">Jade</option>
                <option value="Jeremiah.wav">Jeremiah</option>
                <option value="Jordan.wav">Jordan</option>
                <option value="Julian.wav">Julian</option>
                <option value="Layla.wav">Layla</option>
                <option value="Leonardo.wav">Leonardo</option>
                <option value="Miles.wav">Miles</option>
                <option value="Ryan.wav">Ryan</option>
                <option value="Taylor.wav">Taylor</option>
                <option value="Thomas.wav">Thomas</option>
            </select>
        </div>

        <div class="form-group">
            <label for="text">Text</label>
            <textarea id="text" placeholder="Enter text to synthesize...">Hello! This is a test of the Chatterbox text to speech system.</textarea>
            <div class="tags">
                <span class="tag" data-tag="[laugh]">[laugh]</span>
                <span class="tag" data-tag="[chuckle]">[chuckle]</span>
                <span class="tag" data-tag="[sigh]">[sigh]</span>
                <span class="tag" data-tag="[gasp]">[gasp]</span>
                <span class="tag" data-tag="[cough]">[cough]</span>
                <span class="tag" data-tag="[clear throat]">[clear throat]</span>
                <span class="tag" data-tag="[sniff]">[sniff]</span>
                <span class="tag" data-tag="[groan]">[groan]</span>
            </div>
        </div>

        <button id="generate-btn" onclick="generateTTS()">Generate Speech</button>
    </div>

    <div class="status" id="status"></div>

    <div class="audio-container" id="audioContainer">
        <label>Generated Audio <span class="timer" id="timer"></span></label>
        <audio id="audio" controls></audio>
    </div>

    <script>
        checkModelStatus();

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            if (tab === 'chat') {
                document.querySelector('.tab:first-child').classList.add('active');
                document.getElementById('chat-tab').classList.add('active');
            } else {
                document.querySelector('.tab:last-child').classList.add('active');
                document.getElementById('manual-tab').classList.add('active');
            }
        }

        document.querySelectorAll('.tag').forEach(tag => {
            tag.addEventListener('click', () => {
                const textarea = document.getElementById('text');
                const tagText = tag.dataset.tag;
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                let prefix = start > 0 && text[start-1] !== ' ' ? ' ' : '';
                let suffix = end < text.length && text[end] !== ' ' ? ' ' : '';
                textarea.value = text.slice(0, start) + prefix + tagText + suffix + text.slice(end);
                textarea.focus();
            });
        });

        async function checkModelStatus() {
            try {
                const response = await fetch('/script-model-status');
                const data = await response.json();
                const statusEl = document.getElementById('model-status');
                if (data.loaded) {
                    statusEl.textContent = 'SmolLM3: Loaded';
                    statusEl.className = 'model-status loaded';
                } else {
                    statusEl.textContent = 'SmolLM3: Not loaded (will load on first use)';
                    statusEl.className = 'model-status not-loaded';
                }
            } catch (e) {
                document.getElementById('model-status').textContent = 'SmolLM3: Status unknown';
            }
        }

        async function generateTTS() {
            const text = document.getElementById('text').value.trim();
            const voice = document.getElementById('voice').value;
            const button = document.getElementById('generate-btn');
            const status = document.getElementById('status');
            const audioContainer = document.getElementById('audioContainer');
            const audio = document.getElementById('audio');
            const timer = document.getElementById('timer');

            if (!text) {
                status.textContent = 'Please enter some text';
                status.className = 'status error';
                return;
            }

            button.disabled = true;
            status.textContent = 'Generating speech...';
            status.className = 'status generating';
            audioContainer.classList.remove('visible');

            const startTime = Date.now();

            try {
                const response = await fetch('/tts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: text,
                        voice_mode: 'predefined',
                        predefined_voice_id: voice,
                        output_format: 'wav'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const blob = await response.blob();
                audio.src = URL.createObjectURL(blob);
                audioContainer.classList.add('visible');
                timer.textContent = `(${((Date.now() - startTime) / 1000).toFixed(1)}s)`;
                status.textContent = 'Done!';
                status.className = 'status';
                audio.play();
            } catch (error) {
                status.textContent = error.message;
                status.className = 'status error';
            } finally {
                button.disabled = false;
            }
        }

        async function generateTextOnly() {
            const username = document.getElementById('username').value.trim() || 'User';
            const message = document.getElementById('message').value.trim();
            const style = document.getElementById('chat-style').value;
            const includeTags = document.getElementById('chat-include-tags').checked;
            const button = document.getElementById('text-only-btn');
            const status = document.getElementById('status');
            const responseOutput = document.getElementById('response-output');
            const responseText = document.getElementById('response-text');

            if (!message) {
                status.textContent = 'Please enter a message';
                status.className = 'status error';
                return;
            }

            button.disabled = true;
            status.textContent = 'Generating response...';
            status.className = 'status generating';
            responseOutput.classList.remove('visible');

            const startTime = Date.now();

            try {
                const response = await fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        message: message,
                        style: style,
                        include_tags: includeTags
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const data = await response.json();
                responseText.textContent = data.response;
                responseOutput.classList.add('visible');
                status.textContent = `Generated in ${((Date.now() - startTime) / 1000).toFixed(1)}s`;
                status.className = 'status';
                checkModelStatus();
            } catch (error) {
                status.textContent = error.message;
                status.className = 'status error';
            } finally {
                button.disabled = false;
            }
        }

        async function chatAndSpeak() {
            const username = document.getElementById('username').value.trim() || 'User';
            const message = document.getElementById('message').value.trim();
            const voice = document.getElementById('chat-voice').value;
            const style = document.getElementById('chat-style').value;
            const includeTags = document.getElementById('chat-include-tags').checked;
            const button = document.getElementById('chat-speak-btn');
            const status = document.getElementById('status');
            const audioContainer = document.getElementById('audioContainer');
            const audio = document.getElementById('audio');
            const timer = document.getElementById('timer');
            const responseOutput = document.getElementById('response-output');
            const responseText = document.getElementById('response-text');

            if (!message) {
                status.textContent = 'Please enter a message';
                status.className = 'status error';
                return;
            }

            button.disabled = true;
            document.getElementById('text-only-btn').disabled = true;
            status.textContent = 'Generating response...';
            status.className = 'status generating';
            audioContainer.classList.remove('visible');
            responseOutput.classList.remove('visible');

            const startTime = Date.now();

            try {
                const response = await fetch('/chat-and-speak', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        username: username,
                        message: message,
                        style: style,
                        include_tags: includeTags,
                        voice: voice,
                        output_format: 'wav'
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Generation failed');
                }

                const generatedResponse = response.headers.get('X-Response-Text');
                if (generatedResponse) {
                    responseText.textContent = generatedResponse;
                    responseOutput.classList.add('visible');
                }

                const blob = await response.blob();
                audio.src = URL.createObjectURL(blob);
                audioContainer.classList.add('visible');
                timer.textContent = `(${((Date.now() - startTime) / 1000).toFixed(1)}s)`;
                status.textContent = 'Done!';
                status.className = 'status';
                audio.play();
                checkModelStatus();
            } catch (error) {
                status.textContent = error.message;
                status.className = 'status error';
            } finally {
                button.disabled = false;
                document.getElementById('text-only-btn').disabled = false;
            }
        }

        // Enter key to send
        document.getElementById('message').addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatAndSpeak();
            }
        });
        document.getElementById('text').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') generateTTS();
        });
    </script>
</body>
</html>
